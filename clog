#!/bin/bash

# ==============================================================================
# SCRIPT: clog
# 
# USAGE INSTRUCTIONS:
# To ensure the CLAUDE_CONFIG_DIR "sticks" to your current terminal session,
# you MUST run this script using 'source' or '.':
#
#   source ./clog [optional_number_or_partial_name]
#   OR
#   . ./clog [optional_number_or_partial_name]
#
# PRO TIP: Add an alias to your ~/.bashrc or ~/.zshrc to run this easily:
#   alias clog='source ~/path/to/clog'
#
# If you run it as './clog' without sourcing, the variable will vanish when 
# the script ends.
# ==============================================================================

VERSION="1.1.0"

# Helper to get absolute path cross-platform
get_abs_path() {
    if command -v realpath >/dev/null 2>&1; then
        realpath "$1"
    else
        # Fallback for older macOS/BSD
        echo "$(cd "$(dirname "$1")"; pwd)/$(basename "$1")"
    fi
}

# 1. Handle command line flags (-v, -h, -u)
case "$1" in
    -v|--version)
        echo "clog version $VERSION"
        return 0 2>/dev/null || exit 0
        ;;
    -h|--help)
        SCRIPT_PATH=$(get_abs_path "$0")
        echo "=============================================================================="
        echo "Script: clog"
        echo ""
        echo "Usage instructions:"
        echo "To ensure the CLAUDE_CONFIG_DIR \"sticks\" to your current terminal session,"
        echo "you MUST run this script using 'source' or '.':"
        echo ""
        echo "  source ./clog [optional_number_or_partial_name]"
        echo "  OR"
        echo "  . ./clog [optional_number_or_partial_name]"
        echo ""
        echo "Pro tip: Add an alias to your shell config to run this easily."
        echo ""
        echo "1. Manually add this line to your ~/.bashrc or ~/.zshrc:"
        echo "   alias clog='source $SCRIPT_PATH'"
        echo ""
        echo "2. Or use these shortcut commands to add it automatically:"
        echo "   For Zsh (typically macOS):"
        echo "     echo \"alias clog='source $SCRIPT_PATH'\" >> ~/.zshrc && source ~/.zshrc"
        echo ""
        echo "   For Bash (typically Linux):"
        echo "     echo \"alias clog='source $SCRIPT_PATH'\" >> ~/.bashrc && source ~/.bashrc"
        echo ""
        echo "If you run it as './clog' without sourcing, the variable will vanish when"
        echo "the script ends."
        echo "=============================================================================="
        echo ""
        echo "Options:"
        echo "  [number]       Select a directory by its index in the list"
        echo "  [suffix]       Partial/Case-insensitive match (e.g., 'wo' for .claude-work)"
        echo "  -u, --unset    Clear the CLAUDE_CONFIG_DIR variable"
        echo "  -v, --version  Show version information"
        echo "  -h, --help     Show this help message"
        echo ""
        return 0 2>/dev/null || exit 0
        ;;
    -u|--unset)
        unset CLAUDE_CONFIG_DIR
        echo "ðŸ—‘ï¸  CLAUDE_CONFIG_DIR has been unset."
        return 0 2>/dev/null || exit 0
        ;;
esac

# 2. Detect if script was sourced; warn if not
_clog_is_sourced=false
if [ -n "$ZSH_EVAL_CONTEXT" ]; then
    # zsh: contains ":file" when sourced
    [[ "$ZSH_EVAL_CONTEXT" =~ :file$ ]] && _clog_is_sourced=true
elif [ -n "$BASH_SOURCE" ]; then
    # bash: BASH_SOURCE[0] differs from $0 when sourced
    [[ "${BASH_SOURCE[0]}" != "$0" ]] && _clog_is_sourced=true
fi

if [ "$_clog_is_sourced" = false ]; then
    echo "Note: clog is running in a subshell. CLAUDE_CONFIG_DIR will be set"
    echo "      for this process only, not your terminal session."
    echo "      Unset (clog -u) will not work in this mode."
    echo "      To persist changes, run:  source clog"
    echo ""
fi

# 3. Save original state and find config directories
_clog_original_dir="$CLAUDE_CONFIG_DIR"
config_dirs=($(find ~ -maxdepth 1 -type d -name ".claude-*" 2>/dev/null))
num_options=${#config_dirs[@]}

# 4. Flow 1: Selection Menu (CLAUDE_CONFIG_DIR is not set)
if [ -z "$CLAUDE_CONFIG_DIR" ]; then

    # Handle optional argument (number or partial name)
    if [ -n "$1" ]; then
        _clog_matched=false
        if [[ "$1" =~ ^[0-9]+$ ]]; then
            if [ "$1" -ge 1 ] && [ "$1" -le "$num_options" ]; then
                _clog_i=1
                for _clog_dir in "${config_dirs[@]}"; do
                    if [ "$1" = "$_clog_i" ]; then
                        export CLAUDE_CONFIG_DIR="$_clog_dir"
                        _clog_matched=true
                        break
                    fi
                    _clog_i=$(( _clog_i + 1 ))
                done
            fi
            if [ "$_clog_matched" = false ]; then
                echo "âš ï¸  Warning: '$1' is not a recognized index."
                echo ""
            fi
        else
            _clog_matches=($(find ~ -maxdepth 1 -type d -iname ".claude-*$1*" 2>/dev/null))
            if [ ${#_clog_matches[@]} -eq 1 ]; then
                export CLAUDE_CONFIG_DIR="${_clog_matches[0]}"
                _clog_matched=true
            elif [ ${#_clog_matches[@]} -gt 1 ]; then
                echo "âš ï¸  Multiple matches found for '$1'. Please be more specific."
                echo "Matches: ${_clog_matches[@]##*/}"
                echo ""
            else
                echo "âš ï¸  Warning: '$1' is not a recognized config suffix."
                echo ""
            fi
        fi
    fi

    # Interactive menu if no valid selection was made via argument
    if [ -z "$CLAUDE_CONFIG_DIR" ]; then
        echo "ðŸ” CLAUDE_CONFIG_DIR is not set. Searching for available configs..."
        echo "Please select a configuration directory:"
        echo "   0) Create a new config directory"
        _clog_i=1
        for _clog_dir in "${config_dirs[@]}"; do
            echo "   ${_clog_i}) ${_clog_dir}"
            _clog_i=$(( _clog_i + 1 ))
        done
        echo "   x) Cancel and exit (Esc also works)"

        while true; do
            printf "Enter your choice: "

            # Read single keypress without waiting for Enter
            if [ -n "$ZSH_VERSION" ]; then
                IFS= read -rsk1 _clog_key
            else
                IFS= read -rsn1 _clog_key
            fi
            # Normalize: zsh read -k1 returns $'\n' for Enter; bash read -n1 returns ""
            [[ "$_clog_key" == $'\n' ]] && _clog_key=""

            # Determine if this keypress is immediate (no Enter needed)
            _clog_immediate=false
            if [[ -z "$_clog_key" || "$_clog_key" == $'\e' || "$_clog_key" == "x" || "$_clog_key" == "0" ]]; then
                _clog_immediate=true
            elif [[ "$_clog_key" =~ ^[1-9]$ ]] && [ "$num_options" -lt 10 ]; then
                _clog_immediate=true
            fi

            if [ "$_clog_immediate" = true ]; then
                if [ -n "$_clog_key" ] && [[ "$_clog_key" != $'\e' ]]; then
                    echo "$_clog_key"
                else
                    echo ""
                fi
                REPLY="$_clog_key"
            else
                # Multi-char input: echo first char, read rest of line
                printf "%s" "$_clog_key"
                read -r _clog_rest
                REPLY="${_clog_key}${_clog_rest}"
            fi

            # Handle Escape â†’ cancel
            if [[ "$REPLY" == $'\e' ]]; then
                echo "Exiting without setting variable."
                return 0 2>/dev/null || exit 0
            fi

            # Handle bare Enter â†’ re-prompt (no action in Flow 1)
            if [[ -z "$REPLY" ]]; then
                continue
            fi

            # Handle '0' â†’ create new config directory
            if [[ "$REPLY" == "0" ]]; then
                while true; do
                    printf "Enter a descriptive name (eg. personal, work, max, etc.) for the new config: "
                    read -r new_name
                    if [ -n "$new_name" ]; then
                        new_dir="$HOME/.claude-$new_name"
                        mkdir -p "$new_dir"
                        export CLAUDE_CONFIG_DIR="$new_dir"
                        break 2
                    else
                        echo "âš ï¸ Error: A name is required. Please try again."
                    fi
                done
            fi

            # Handle 'x' or 'exit' â†’ cancel
            if [[ "$REPLY" == "x" || "$REPLY" == "exit" ]]; then
                echo "Exiting without setting variable."
                return 0 2>/dev/null || exit 0
            fi

            # Handle numeric directory selection
            if [[ "$REPLY" =~ ^[0-9]+$ ]] && [ "$REPLY" -ge 1 ] && [ "$REPLY" -le "$num_options" ]; then
                _clog_i=1
                for _clog_dir in "${config_dirs[@]}"; do
                    if [ "$REPLY" = "$_clog_i" ]; then
                        export CLAUDE_CONFIG_DIR="$_clog_dir"
                        break 2
                    fi
                    _clog_i=$(( _clog_i + 1 ))
                done
            fi

            echo "Invalid option. Please try again."
        done
    fi
fi

# 5. Confirmation (shown when Flow 1 just set the value)
if [ -n "$CLAUDE_CONFIG_DIR" ] && [ -z "$_clog_original_dir" ]; then
    echo "----------------------------------------------------------------"
    echo "ðŸš€ Environment updated!"
    echo "Variable : CLAUDE_CONFIG_DIR"
    echo "Value    : $CLAUDE_CONFIG_DIR"
    if [ "$_clog_is_sourced" = true ]; then
        echo "Status   : Active for this terminal session."
    else
        echo "Status   : Set in this subshell only (source clog to persist)."
    fi
    echo ""
    echo "To verify or set this manually, run:"
    echo "  echo \$CLAUDE_CONFIG_DIR"
    echo "  export CLAUDE_CONFIG_DIR=\"$CLAUDE_CONFIG_DIR\""
    echo "----------------------------------------------------------------"
    echo ""
fi

# 6. Flow 2: Launch Prompt (CLAUDE_CONFIG_DIR is set)
if [ -n "$CLAUDE_CONFIG_DIR" ]; then
    echo "âœ… CLAUDE_CONFIG_DIR is set to: $CLAUDE_CONFIG_DIR"
    if [ "$_clog_is_sourced" = true ]; then
        echo "   Run 'clog -u' or 'clog --unset' to clear it."
    fi
    echo ""
    echo "   Enter) Launch Claude Code with config dir: ${CLAUDE_CONFIG_DIR##*/}"
    if [ "$_clog_is_sourced" = true ]; then
        echo "   u) Unset CLAUDE_CONFIG_DIR"
    fi
    echo "   Any other key) Exit"

    # Read single keypress without waiting for Enter
    if [ -n "$ZSH_VERSION" ]; then
        IFS= read -rsk1 _clog_key
    else
        IFS= read -rsn1 _clog_key
    fi
    # Normalize: zsh read -k1 returns $'\n' for Enter; bash read -n1 returns ""
    [[ "$_clog_key" == $'\n' ]] && _clog_key=""

    # Handle Enter â†’ launch Claude Code
    if [ -z "$_clog_key" ]; then
        echo ""
        echo "ðŸš€ Launching Claude Code..."
        claude
        return 0 2>/dev/null || exit 0
    fi

    # Handle 'u' â†’ unset (only when sourced)
    if [[ "$_clog_key" == "u" ]] && [ "$_clog_is_sourced" = true ]; then
        echo ""
        unset CLAUDE_CONFIG_DIR
        echo "ðŸ—‘ï¸  CLAUDE_CONFIG_DIR has been unset."
        return 0 2>/dev/null || exit 0
    fi

    # Any other key â†’ exit
    echo ""
fi